<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×—×“×¨ ×‘×§×¨×” ×œ×× ×—×”</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #222; font-family: sans-serif; overflow: hidden; }
        #main-container { width: 100%; height: calc(100% - 80px); background: #000; }
        #final-canvas { width: 100%; height: 100%; }
        #controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; gap: 15px; }
        #controls button { background-color: #333; color: white; border: 1px solid #555; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; }
        #controls button.active { background-color: #007acc; }
        #controls button.leave { background-color: #e74c3c; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <video id="camera-source" class="hidden" autoplay muted playsinline></video>
    <video id="screen-source" class="hidden" autoplay muted playsinline></video>

    <div id="main-container">
        <canvas id="final-canvas"></canvas>
    </div>

    <div id="controls">
        <button id="mic-btn" title="×©××¢">ğŸ¤</button>
        <button id="cam-btn" title="××¦×œ××”">ğŸ“·</button>
        <button id="screen-btn" title="×©×™×ª×•×£ ××¡×š">ğŸ–¥ï¸</button>
        <button id="leave-btn" class="leave" title="×¡×™×™× ×©×™×“×•×¨">ğŸ“</button>
    </div>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <script>
        const APP_ID = "517f71a5aa8a45a8a222341136c439c4"; // !!! ×”×—×œ×£ ×‘××–×”×” ×”×××™×ª×™ ×©×œ×š

        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        client.setClientRole("host");

        const urlParams = new URLSearchParams(window.location.search);
        const channelName = urlParams.get('channel');

        const localTracks = {
            micAudioTrack: null,
            canvasVideoTrack: null,
            cameraStream: null,
            screenStream: null
        };

        const canvas = document.getElementById('final-canvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;

        // --- ×œ×•×’×™×§×ª ××™×—×•×“ ×”×•×™×“××• (×§× ×‘×¡) ---
        function drawStreams() {
            if (!canvas.offsetParent) { // ××¤×¡×™×§ ×œ×¦×™×™×¨ ×× ×”×§× ×‘×¡ ×œ× × ×¨××”
                cancelAnimationFrame(animationFrameId);
                return;
            }
            // ×”×’×“×¨×ª ×’×•×“×œ ×”×§× ×‘×¡ ×‘×”×ª×× ×œ×’×•×“×œ ×”×—×œ×•×Ÿ
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ×¦×™×™×¨ ××ª ×©×™×ª×•×£ ×”××¡×š ×¢×œ ×›×œ ×”×§× ×‘×¡
            const screenVideo = document.getElementById('screen-source');
            if (localTracks.screenStream) {
                ctx.drawImage(screenVideo, 0, 0, canvas.width, canvas.height);
            }

            // ×¦×™×™×¨ ××ª ×”××¦×œ××” ×‘×¤×™× ×”
            const cameraVideo = document.getElementById('camera-source');
            if (localTracks.cameraStream) {
                const camWidth = canvas.width * 0.2; // 20% ×¨×•×—×‘
                const camHeight = camWidth * (cameraVideo.videoHeight / cameraVideo.videoWidth);
                const margin = 20;
                ctx.drawImage(cameraVideo, canvas.width - camWidth - margin, canvas.height - camHeight - margin, camWidth, camHeight);
            }

            animationFrameId = requestAnimationFrame(drawStreams);
        }

        // --- × ×™×”×•×œ ×©×™×“×•×¨ ---
        async function startBroadcast() {
            if (localTracks.canvasVideoTrack) return; // ×›×‘×¨ ××©×“×¨×™×
            const canvasStream = canvas.captureStream(30); // 30 FPS
            localTracks.canvasVideoTrack = AgoraRTC.createCustomVideoTrack({
                mediaStreamTrack: canvasStream.getVideoTracks()[0]
            });
            await client.publish(localTracks.canvasVideoTrack);
        }
        
        async function stopBroadcast() {
            if (localTracks.canvasVideoTrack) {
                await client.unpublish(localTracks.canvasVideoTrack);
                localTracks.canvasVideoTrack.close();
                localTracks.canvasVideoTrack = null;
            }
        }

        // --- ×›×¤×ª×•×¨×™× ---
        document.getElementById('cam-btn').onclick = async (e) => {
            const btn = e.currentTarget;
            if (btn.classList.contains('active')) {
                localTracks.cameraStream.getTracks().forEach(track => track.stop());
                localTracks.cameraStream = null;
                document.getElementById('camera-source').srcObject = null;
                btn.classList.remove('active');
            } else {
                localTracks.cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('camera-source').srcObject = localTracks.cameraStream;
                btn.classList.add('active');
            }
        };

        document.getElementById('screen-btn').onclick = async (e) => {
            const btn = e.currentTarget;
            if (btn.classList.contains('active')) {
                localTracks.screenStream.getTracks().forEach(track => track.stop());
                localTracks.screenStream = null;
                document.getElementById('screen-source').srcObject = null;
                await stopBroadcast();
                btn.classList.remove('active');
            } else {
                try {
                    localTracks.screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    document.getElementById('screen-source').srcObject = localTracks.screenStream;
                    await startBroadcast();
                    btn.classList.add('active');
                } catch(err) { console.error("Screen share failed", err); }
            }
        };
        
        document.getElementById('mic-btn').onclick = async (e) => {
            const btn = e.currentTarget;
            if (btn.classList.contains('active')) {
                await client.unpublish(localTracks.micAudioTrack);
                localTracks.micAudioTrack.close();
                localTracks.micAudioTrack = null;
                btn.classList.remove('active');
            } else {
                localTracks.micAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                await client.publish(localTracks.micAudioTrack);
                btn.classList.add('active');
            }
        };

        document.getElementById('leave-btn').onclick = async () => {
            cancelAnimationFrame(animationFrameId);
            await client.leave();
            alert("×”×©×™×“×•×¨ ×”×¡×ª×™×™×");
            window.location.reload();
        };

        // --- ×”×ª×—×œ×” ---
        async function main() {
            await client.join(APP_ID, channelName, null, null);
            drawStreams(); // ××ª×—×™×œ ××ª ×œ×•×œ××ª ×”×¦×™×•×¨
        }
        main();
    </script>
</body>
</html>
