<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×—×“×¨ ×‘×§×¨×” ×œ×× ×—×”</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #222; color: white; font-family: sans-serif; overflow: hidden; }
        #main-view { position: relative; width: 100%; height: calc(100% - 80px); /* ×’×•×‘×” ××œ× ×¤×—×•×ª ×’×•×‘×” ×©×•×¨×ª ×”×›×¤×ª×•×¨×™× */ }
        #screen-container { width: 100%; height: 100%; background-color: #000; display: flex; align-items: center; justify-content: center; }
        #screen-container p { font-size: 1.5em; color: #555; }
        #camera-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 20%;
            min-width: 150px;
            border: 2px solid #00aaff;
            border-radius: 8px;
            overflow: hidden;
            background-color: #111;
            display: none; /* ××•×¡×ª×¨ ×‘×”×ª×—×œ×” */
        }
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        #controls button {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #controls button:hover { background-color: #444; }
        #controls button.active { background-color: #007acc; border-color: #00aaff; }
        #controls button.leave { background-color: #e74c3c; }
    </style>
</head>
<body>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

    <div id="main-view">
        <div id="screen-container"><p>×©×™×ª×•×£ ×”××¡×š ×™×•×¤×™×¢ ×›××Ÿ</p></div>
        <div id="camera-container"></div>
    </div>

    <div id="controls">
        <button id="mic-btn" title="×”×¤×¢×œ/×”×©×ª×§ ×©××¢">ğŸ¤</button>
        <button id="cam-btn" title="×”×¤×¢×œ/×›×‘×” ××¦×œ××”">ğŸ“·</button>
        <button id="screen-btn" title="×©×ª×£/×”×¤×¡×§ ×©×™×ª×•×£ ××¡×š">ğŸ–¥ï¸</button>
        <button id="leave-btn" class="leave" title="×¡×™×™× ×©×™×“×•×¨">ğŸ“</button>
    </div>

    <script>
        const APP_ID = "5c3ec68539331ff3c656"; // !!! ×”×—×œ×£ ×‘××–×”×” ×”××¤×œ×™×§×¦×™×” ×©×œ×š

        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        client.setClientRole("host");

        const localTracks = { videoTrack: null, audioTrack: null, screenTrack: null };
        const urlParams = new URLSearchParams(window.location.search);
        const channelName = urlParams.get('channel');

        // --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ---
        async function join() {
            try {
                await client.join(APP_ID, channelName, null, null);
            } catch (error) {
                console.error("Failed to join channel", error);
            }
        }

        async function leave() {
            for (let trackName in localTracks) {
                const track = localTracks[trackName];
                if (track) {
                    track.stop();
                    track.close();
                    localTracks[trackName] = null;
                }
            }
            await client.leave();
            window.location.reload(); // ×˜×•×¢×Ÿ ××—×“×© ××ª ×”×“×£ ×œ××¦×‘ ×”×ª×—×œ×ª×™
        }

        // --- × ×™×”×•×œ ×›×¤×ª×•×¨×™× ---
        document.getElementById('mic-btn').onclick = async () => {
            if (localTracks.audioTrack) {
                const isEnabled = localTracks.audioTrack.isEnabled;
                await localTracks.audioTrack.setEnabled(!isEnabled);
                document.getElementById('mic-btn').style.opacity = isEnabled ? 0.5 : 1;
            } else {
                localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                await client.publish(localTracks.audioTrack);
                document.getElementById('mic-btn').classList.add('active');
            }
        };

        document.getElementById('cam-btn').onclick = async () => {
            const camContainer = document.getElementById('camera-container');
            if (localTracks.videoTrack) {
                await client.unpublish(localTracks.videoTrack);
                localTracks.videoTrack.stop();
                localTracks.videoTrack.close();
                localTracks.videoTrack = null;
                camContainer.style.display = 'none';
                document.getElementById('cam-btn').classList.remove('active');
            } else {
                localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();
                camContainer.style.display = 'block';
                localTracks.videoTrack.play('camera-container');
                await client.publish(localTracks.videoTrack);
                document.getElementById('cam-btn').classList.add('active');
            }
        };
        
        document.getElementById('screen-btn').onclick = async () => {
            if (localTracks.screenTrack) {
                await client.unpublish(localTracks.screenTrack);
                localTracks.screenTrack.stop();
                localTracks.screenTrack.close();
                localTracks.screenTrack = null;
                document.getElementById('screen-container').innerHTML = '<p>×©×™×ª×•×£ ×”××¡×š ×™×•×¤×™×¢ ×›××Ÿ</p>';
                document.getElementById('screen-btn').classList.remove('active');
            } else {
                try {
                    localTracks.screenTrack = await AgoraRTC.createScreenVideoTrack({ encoderConfig: "1080p_1" }, "auto");
                    document.getElementById('screen-container').innerHTML = ''; // ×× ×§×” ××ª ×”×˜×§×¡×˜
                    localTracks.screenTrack.play('screen-container');
                    await client.publish(localTracks.screenTrack);
                    document.getElementById('screen-btn').classList.add('active');
                    // ×××–×™×Ÿ ×œ××§×¨×” ×©×”××©×ª××© ×™×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×”×¤×¡×§ ×©×™×ª×•×£" ×”××•×‘× ×” ×©×œ ×”×“×¤×“×¤×Ÿ
                    localTracks.screenTrack.on("track-ended", () => {
                        document.getElementById('screen-btn').click(); // ××¤×¢×™×œ ××ª ×”×œ×•×’×™×§×” ×©×œ ×›×™×‘×•×™ ×”×›×¤×ª×•×¨
                    });
                } catch (error) {
                    console.error("Screen share failed or cancelled", error);
                }
            }
        };

        document.getElementById('leave-btn').onclick = leave;

        // ×”×ª×—×‘×¨×•×ª ××•×˜×•××˜×™×ª ×œ×¢×¨×•×¥ ×›×©×”×“×£ × ×˜×¢×Ÿ
        join();

    </script>
</body>
</html>
