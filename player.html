<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Player View</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #main-container { display: flex; width: 100%; height: 100%; }
        #broadcast-section { flex: 3; background: #000; position: relative; }
        #screen-view { width: 100%; height: 100%; }
        #camera-view {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 20%;
            border: 2px solid #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        #controller-section { flex: 1; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

    <div id="main-container">
        <div id="broadcast-section">
            <div id="screen-view"></div>
            <div id="camera-view"></div>
        </div>
        <div id="controller-section">
            <iframe id="controller-frame"></iframe>
        </div>
    </div>

    <script>
        const APP_ID = "7a4ca0575af042af8dfa532bc7657e0e"; // !!! החלף במזהה האפליקציה שלך

        const urlParams = new URLSearchParams(window.location.search);
        const channelName = urlParams.get('channel');
        const gameCode = urlParams.get('gamecode');

        const controllerUrl = `https://game.clicker.co.il/phone.html?code=${gameCode}`;
        document.getElementById('controller-frame').src = controllerUrl;

        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        client.setClientRole("audience");

        async function subscribeToUser(user, mediaType) {
            await client.subscribe(user, mediaType);
            if (mediaType === "video") {
                // בודק אם הוידאו הוא שיתוף מסך
                const isScreenTrack = user.videoTrack.getMediaStreamTrack().getSettings().displaySurface;
                if (isScreenTrack) {
                    user.videoTrack.play('screen-view');
                } else {
                    user.videoTrack.play('camera-view');
                }
            }
            if (mediaType === "audio") {
                user.audioTrack.play();
            }
        }

        async function joinAndSubscribe() {
            try {
                await client.join(APP_ID, channelName, null, null);
                client.on("user-published", subscribeToUser);
                client.on("user-unpublished", (user, mediaType) => {
                    // כאן תוכל להוסיף לוגיקה להסרת הוידאו אם המנחה מפסיק לשתף
                });
            } catch (error) {
                console.error("Failed to join or subscribe", error);
            }
        }
        
        joinAndSubscribe();
    </script>
</body>
</html>
